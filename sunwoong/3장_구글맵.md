구글 맵은 위성 이미지, 거리 뷰, 실시간 교통 상황, 경로 계획 등 다양한 서비스를 제공하고 있다. 구글 맵은 사용자가 목적지와 경로를 찾을 수 있도록 돕는다.

### 1단계. 문제 이해 및 설계 범위 확정

---

- 10억 DAU
- 위치 갱신, 경로 안내, ETA(예상 도착 시간), 지도 표시
- 도로 데이터는 확보 됨. 수 TB 수준의 가공되지 않은 데이터
- 교통 상황 고려
- 다양한 이동 방법 지원
- 경유지 X

**기능 요구사항**

- 사용자 위치 갱신
- 경로 안내 서비스 (ETA 포함)
- 지도 표시

**비기능 요구사항 및 제약 사항**

- 정확도
- 부드러운 경로 표시
- 데이터 및 배터리 사용량
- 가용성 및 규모 확장성 고려

### **지도 101**

---

**측위 시스템**

세계는 축을 중심으로 회전하는 구이다. 측위 시스템은 이 구 표면 상의 위치를 표현하는 체계를 말한다. 위경도 기반 측위 시스템의 경우 최상단에 북극이 있고 최하단에 남극이 있다. 위도는 (북/남) 경도는 (동/서)를 의미한다.

**3차원 위치의 2차원 변환**

3차원 구 위의 위치를 2차원 평면에 대응시키는 절차를 지도 투영법 또는 도법이라 한다. 도법은 다양하지만 실제 지형의 기하학적 특성을 왜곡한다는 공통점을 가진다.

구글 맵은 메르카토르 도법을 조금 변경한 웹 메르카토르 도법을 택하고 있다.

**지오코딩**

지오코딩은 주소를 지리적 측위 시스템의 좌표로 변환하는 프로세스다. 지오코딩을 수행하는 한 가지 방법은 인터폴레이션이며 GIS와 같은 다양한 시스템이 제공하는 데이터를 결합한다는 뜻이다. GIS는 도로망을 지리적 좌표 공간에 대응시키는 방법을 제공하는 여러 시스템 가운데 하나다.

**지오해싱**

지오해싱은 지도 위 특정 영역을 영문자와 숫자로 구성된 짧은 문자열에 대응시키는 인코딩 체계다. 2차원의 평면 공간으로 표현된 지리적 영역 위의 격자를 더 작은 격자로 재귀적으로 분할해 나간다. 본 설계안에서 맵 타일 관리에 지오해싱을 적용한다.

**지도 표시**

지도를 화면에 표시하는데 가장 기본이 되는 개념은 타일이다. 지도 전부를 하나의 이미지로 표시하는 대신, 작은 타일로 쪼개어 표시하는 것이다. 클라이언트는 사용자가 보려는 영역에 관계된 타일만 다운받아 모자이크처럼 이어 붙인 다음 화면에 뿌린다.

지도의 확대/축소를 지원하려면 확대 수준에 따라 다른 종류의 타일을 준비해야 한다. 클라이언트는 지도의 확대 수준에 근거하여 어떤 크기의 타일을 가져올지 고른다.

**경로 안내 알고리즘을 위한 도로 데이터 처리**

경로 탐색 알고리즘은 대부분 다익스크라 알고리즘이나 A* 경로 탐색 알고리즘의 변종이다. 교차로를 노드, 도로는 선으로 표현한 그래프 자료구조를 사용한다.

대부분의 경로 탐색 알고리즘의 성능은 주어진 그래프 크기에 아주 민감하다. 좋은 성능을 보이려면 그래프를 관리 가능 단위로 분할할 필요가 있다.

지오해싱과 비슷한 분할 기술을 적용하여 격자로 나누고 각 격자 안의 도로망을 노드와 선으로 구성된 그래프 자료구조로 변환한다. 이때 각 격자는 경로 안내 타일이라 부른다. 각 타일은 도로로 연결된 다른 타일에 대한 참조를 유지한다.

**계층적 경로 안내 타일**

경로 안내가 효과적으로 동작하려면 필요한 수준의 구체성을 갖춘 도로 데이터가 필요하다. 보통 상, 중, 하로 구분하여 세 가지 종류의 경로 안내 타일을 준비한다. 상에는 지방도, 중에는 더 넓은 지역과 관할구를 있는 간선 도로, 하에는 도시와 주를 연결하는 고속도로 데이터를 둔다.

### 2단계. 개략적 설계안 제시 및 동의 구하기

---

- 위치 서비스
- 경로 안내 서비스
- 지도 표시

**위치 서비스**

사용자의 위치를 기록하는 역할을 담당한다. 클라이언트가 t초마다 자기 위치를 전송한다고 가정한다. 여기서 t는 설정이 가능한 값이다. 주기적으로 위치 정보를 전송하면 몇 가지 좋은 점이 있다. 해당 데이터 스트림을 활용하여 시스템을 점차 개선할 수 있으며 ETA를 좀 더 정확하게 산출할 수 있고 교통 상황에 따라 다른 경로를 안내할 수도 있다.

그러나 위치 이력을 클라이언트에 버퍼링 해두었다가 일괄 요청하면 전송 빈도를 줄일 수 있을 것이다. 구글 맵과 같은 시스템은 이렇게 해서 위치 갱신 요청 빈도를 줄여도 여전히 많은 쓰기 요청을 처리해야 한다. 따라서 카산드라 같은 데이터베이스가 필요하다.

HTTP를 keep-alive 옵션과 함께 사용하면 효율을 높일 수 있으므로 좋은 선택일 것이다.

**경로 안내 서비스**

A에서 B 지점으로 가는 합리적으로 빠른 경로를 찾아 주는 역할을 담당한다.

**지도 표시**

클라이언트는 언제 지도 타일을 서버에서 가져오는가?

- 사용자가 지도를 확대 또는 이동시키며 주변을 탐색한다.
- 경로 안내가 진행되는 동안 사용자의 위치가 현재 지도 타일을 벗어나 인접한 타일로 이동한다.

다량의 지도 타일 데이터를 서버에서 효과적으로 가져오려면 어떻게 해야 할까?

- 클라이언트의 위치, 지도의 확대 수준에 근거하여 필요한 지도 타일을 즉석에서 만드는 방안
    - 모든 지도 타일을 동적으로 만들어야 하는 서버 클러스터에 심각한 부하가 걸림
    - 캐시를 활용하기 어려움
- 확대 수준별로 미리 만들어 둔 지도 타일을 클라이언트에 전달하기만 하는 방안
    - 각 지도 타일이 담당하는 지리적 영역은 지오해싱 같은 분할법을 사용해 만든 고정된 사각형 격자로 표현되므로 정적이다.
    - 확대 수준에 근거하여 필요한 지도 타일 집합을 결정
    - 해당 위치를 지오해시 URL로 변환한 후 정적 이미지는 CDN을 통해 서비스

### 3단계. 상세 설계

---

**<데이터 모델>**

- 경로 안내 타일
- 사용자 위치
- 지오코딩 데이터
- 미리 계산해 둔 지도 타일 데이터

**경로 안내 타일**

이 데이터의 용량은 수 테라바이트에 달하며 애플리케이션이 지속적으로 수집한 사용자 위치 데이터를 통해 끊임없이 개선된다.

이 데이터는 방대한 양의 도로 및 그 메타데이터로 구성된다. 그래프 자료구조 형태로 가공되지 않은 데이터이므로 주어진 상태 그대로는 경로 안내 알고리즘의 입력으로 활용할 수 없다. 그러므로 경로 안내 타일 처리 서비스라 불리는 오프라인 데이터 가공 파이프라인을 주기적으로 실행하여 경로 안내 타일로 변환한다. 도로 데이터에 발생한 새로운 변경사항을 반영하기 위해서다.

경로 안내 타일 처리 서비스는 가공 결과로 만든 타일을 어디에 저장해야 할까?

- 그래프 데이터는 메모리에 인접 리스트 형태로 보관하는 것이 일반적이다.
- S3 같은 객체 저장소에 파일을 보관하고 그 파일을 이용할 경로 안내 서비스에서 적극적으로 캐싱한다.
    - 지오해시 기준으로 분류해두면 위도와 경도가 주어졌을 때 타일을 신속하게 찾을 수 있다.

**사용자 위치 데이터**

도로 데이터 및 경로 안내 타일을 갱신하는 데 이용되며, 실시간 교통 상황 데이터나 교통 상황 이력 데이터베이스를 구축하는 데도 활용된다. 또한, 데이터 스트림 프로세싱 서비스는 이 위치 데이터를 처리하여 지도 데이터를 갱신한다.

| user_id | timestamp | user_mode | driving_mode | location |
| --- | --- | --- | --- | --- |
| 101 | 12323423 | active | driving | (20.0, 30.5) |

**지오코딩 데이터베이스**

주소를 위도/경도 쌍으로 변환하는 정보를 보관한다. 읽기 연산은 빈번한 반면에 쓰기 연산은 드물게 발생하기 때문에 레디스와 같은 빠른 읽기 연산을 제공하는 키-값 저장소가 이 용도에 적당하다.

출발지/목적지 주소는 경로 계획 서비스에 전달하기 전에 이 데이터베이스를 통해 위도/경도 쌍으로 변환되어야 한다.

**미리 만들어 둔 지도 이미지**

단말이 특정 영역의 지도를 요청하면 인근 도로 정보를 취합하여 모든 도로 및 관련 상세 정보가 포함된 이미지를 만들어 내야 한다.

이미지는 지도 표시에 사용되는 확대 수준별로 미리 만들어 두고 CDN을 통해 전송한다.

### **서비스**

---

**<위치 서비스>**

사용자 위치 데이터 저장에는 키-값 저장소를 활용한다. 쓰기 연산이 빈번하므로 쓰기 연산 지원에 효율적인 데이터베이스가 필요하다. NoSQL 키-값 데이터베이스나 열-중심 데이터베이스가 요구사항에 적합하다. 또한, 사용자 위치는 계속 변화하기 때문에 데이터 일관성보다는 가용성이 더 중요하다. 따라서 CAP 정리에 따라 가용성과 분할 내성을 만족시키는데 집중하는 것이 좋다.

카산드라는 높은 가용성을 보장하면서도 막대한 규모의 연산을 감당할 수 있도록 해 줄 것이다.

데이터베이스 키로는 (user_id, timestamp)의 조합을 사용하며, 해당 키에 매달리는 값으로는 위도/경도 쌍을 저장한다. 이때 user_id는 파티션 키이며 timestamp는 클러스터링 키로 활용된다.

즉, user_id를 파티션 키로 사용하여 특정 사용자의 최근 위치를 신속히 읽어내고 클러스터링 키 값에 따라 정렬된 값을 사용하면 특정 사용자의 특정 기간 내 위치도 효율적으로 읽을 수 있다.

**사용자 위치 데이터는 어떻게 이용되는가?**

새로 개설되었거나 폐쇄된 도로를 감지, 지도 데이터의 정확성을 점차로 개선하는 입력, 실시간 교통 현황을 파악하는 입력으로 사용될 수 있다.

이런 용례를 지원하기 위해서 사용자 위치를 데이터베이스에 기록하는 것과 별도로 카프카와 같은 메시지 큐에 로깅한다.

카프카는 응답 지연이 낮고 많은 데이터를 동시에 처리할 수 있는 데이터 스트리밍 플랫폼으로 실시간 데이터 피드를 지원하기 위해 고안 되었다.

개별 서비스는 카프카를 통해 전달되는 사용자 위치 데이터 스트림을 각자 용도에 맞게 활용한다.

**<지도 표시>**

**지도 타일 사전 계산**

사용자가 보는 지도 크기나 확대 수준에 맞는 세부사항을 보여주기 위해서는 확대 수준별 지도 타일을 미리 만들어 둘 필요가 있다.

확대 수준 0은 256 * 256 픽셀 타일 하나로 표현한다. 확대 수준을 1단계 올릴 때마다 해당 수준을 위한 전체 타일 수는 동서 방향으로 두 배, 남북 방향으로 두 배 늘어난다.

늘어난 해상도 덕에 사용자에게 더 상세한 정보를 제공할 수 있다. 즉, 클라이언트는 타일 다운 받는 데 많은 네트워크 대역폭을 소진하지 않고도 클라이언트에 설정된 확대 수준에 최적인 크기의 지도를 표시할 수 있다. 화면에 한 번에 표시 가능한 지도 타일 개수는 달라지지 않기 때문이다.

**최적화: 벡터 사용**

WebGL 기술을 채택하면 네트워크를 통해 이미지를 전송하는 대신 경로와 다각형 등의 벡터 정보를 보내는 것이다. 클라이언트는 수신된 경로와 다각형 정보를 통해 지도를 그려내면 된다.

벡터 타일은 이미지에 비해 월등한 압축률을 가지고 있다. 따라서 네트워크 대역폭을 많이 아낄 수 있다.

또한, 훨씬 매끄러운 지도 확대 경험이다. 래스터 방식 이미지를 사용하면 클라이언트가 확대 수준을 높이는 순간에 이미지가 늘어지고 픽셀이 도드라져 보이는 문제가 있다. 하지만 벡터화 된 이미지를 사용하면 클라이언트는 각 요소 크기를 적절하게 조정할 수 있다.

**<경로 안내 서비스>**

가장 빠른 경로를 안내하는 역할을 한다.

**지오코딩 서비스**

주소를 위도와 경도 쌍으로 바꿔주는 서비스가 필요하다. 주소의 표현 방식은 다양할 수 있다는 점을 고려해야 한다. 즉, 장소 이름으로 나타낸 주소도 있을 수 있고 지번 형태로 나타낸 주소도 있을 수 있다.

경로 안내 서비스는 이 서비스를 호출하여 출발지와 목적지 주소를 위도/경도 쌍으로 변환한 뒤 추후 다른 서비스 호출에 이용한다.

**경로 계획 서비스**

경로 계획 서비스는 현재 교통 상황과 도로 상태에 입각하여 이동 시간 측면에서 최적화된 경로를 제안하는 역할을 담당한다.

**최단 경로 서비스**

출발지와 목적지 위도/경도를 입력으로 받아 k개 최단 경로를 반환하는 서비스다. 도로 구조에만 의존하여 계산을 수행하며 도로망 그래프는 거의 정적이므로 캐시해 두면 좋다.

최단 경로 서비스는 객체 저장소에 저장된 경로 안내 타일에 대해 A* 경로 탐색 알고리즘의 한 형태를 실행한다.

- 입력으로 출발지와 목적지의 위도/경도를 받는다. 이 위치 정보를 지오해시로 변환한 다음 출발지와 목적지 경로 안내 타일을 얻는다.
- 출발지 타일에서 시작하여 그래프 자료구조를 탐색해 나간다. 탐색 범위를 넓히는 과정에서 필요한 주변 타일은 객체 저장소에서 가져온다. 같은 지역의 다른 확대 수준 타일로도 연결이 존재할 수 있음에 유의하자. 예를 들어 고속도로만 있는 더 큰 타일로 진입하는 경우가 있다. 최단 경로가 충분히 확보될 때까지 알고리즘은 검색 범위를 계속 확대해 나가면서 필요한 만큼 타일을 가져오는 작업을 반복할 것이다.

**예상 도착 시간 서비스**

경로 계획 서비스는 최단 경로 목록을 수신하면 예상 도착 시간 서비스를 호출하여 그 경로 각각에 대한 소요 시간 추정치를 구한다.

예상 도착 시간 서비스는 기계 학습을 활용해 현재 교통 상황 및 과거 이력을 근거하여 예상 도착 시간을 계산한다.

**순위 결정 서비스**

경로 계획 서비스는 ETA 예상치를 구하고 나면 순위 결정 서비스에 관련 정보를 모두 전달하여 사용자가 정의한 필터링 조건을 적용한다.

유료 도로 제외, 고속도로 제외 등이 그런 필터링 조건의 사례다. 순위 결정 서비스는 필터링이 끝나고 남은 경로를 소요 시간 순으로 정렬하여 최단 시간 경로 k개를 구한 다음 경로 안내 서비스에 결과를 안내한다.

**중요 정보 갱신 서비스들**

카프카 위치 데이터 스트림을 구독하고 있다가 중요 데이터를 비동기적으로 업데이트하여 그 상태를 항상 최신으로 유지하는 역할을 담당한다.

실시간 교통 정보 데이터베이스나 경로 안내 타일 등이 그 사례다.