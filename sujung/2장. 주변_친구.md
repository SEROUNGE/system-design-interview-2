# 2장. 주변 친구

이번 장에서는 '주변 친구'라는 모바일 앱 기능을 지원하는 규모 확장성이 용이한 백엔드 시스템을 설계해보도록 하겠습니다.
'주변 친구' 기능이란, 앱 사용자 가운데 본인의 위치 정보 접근 권한을 허락한 사용자에 한해, 인근의 친구 목록을 보여주는 시스템입니다.

---
## 1단계. 문제 이해 및 설계 범위 확정
질문을 던져서 설계범위를 좁혀봅시다. <br>
하단의 5개 항목들은  `면접관 - 면접자 질문 💬` 으로 실제 얻어낸 정보들입니다.

* 지리적으로 `가깝다` 라는 것의 기준: 두 사용자 간의 직선 거리 5km
* 10억명을 가정하고, 그 가운데 10% 정도가 해당 기능을 사용
* 사용자 이동 이력 보관 여부 - 기계 학습 등 여러가지 용도로 활용될 수 있으므로, Yes
* 친구 관계에 있는 사용자가 10분 이상 비활성화 상태면, 해당 사용자를 주변 친구 목록에서 사라지도록 한다.
* 사생활 및 데이터 보호법 고려 - 일단 설계단계에서는 생략

### 기능적 요구사항 ⚒️
* 사용자는 모바일 앱에서 주변 친구를 확인할 수 있어야 한다.
  * 주변 친구 목록에 보이는 각 항목에는 해당 친구까지의 거리, 해당 정보가 마지막으로 갱신된 시각(`timestamp`) 가 함께 표시되어야 한다.
  * 몇 초마다 한 번씩 주변 친구 목록이 갱신되어야 한다.
 
### 비기능적 요구사항 🥳
* 낮은 지연시간(low latency): 위치 변화가 반영되는 데 너무 오랜 시간이 걸리지 X
* 안정성: 전반적으로 안정적이어야 하지만, 때로는 몇 개 데이터가 유실되는 것은 용인 가능
* 결과적 일관성(eventual consistency): 위치 데이터를 저자하기 위해, 강한 일관성을 지원하는 데이터 저장소를 사용할 필요는 없다. → 복제본의 데이터가 원본과 동일하게 변경되기까지 몇 초 정도 걸리는 것은 용인할 수 O


 해당 정보들을 바탕으로, 제약사항과 가정들을 정리해봅시다.

1. `주변 친구` 는 5마일(8km) 반경 이내의 친구로 정의합니다.
2. 친구 위치 정보는 30초 주기로 갱신합니다. (사람이 걷는 속도 고려)
3. 평균적으로 매일 주변 친구 검색 기능을 활용하는 사용자는 1억 명으로 가정합니다.
4. 동시 접속 사용자의 수는 DAU 수의 10%로 가정합니다. → 1억 명의 10%인 1000만명이 동시에 시스템을 사용한다고 가정합니다.
5. 평균적으로 한 사용자는 400명의 친구를 갖는다고 가정합니다. 그리고 그 모두가 주변 친구 검색 기능을 활용한다고 가정합니다.

**QPS 계산** <br>
1억 DAU<br>
동시 접속 사용자: 10% * 1억 = 1000만<br>
사용자는 30초마다 자기 위치를 시스템에 전송 <br>
위치 정보 계산 QPS = 천만 / 30 =~ 334,000<br>

## 2단계. 개략적 규모 추정
이제 개략적 설계, API 설계, 데이터 모델에 관련한 내용을 살펴봅시다.<br>
이 장에서 해결하는 문제의 경우, 위치 정보를 모든 친구에게 전송(PUSH)해야 한다는 이슈 때문에 클-서 사이의 통신이 **단순 HTTP 프로토콜을 사용하지 못하게 될 수 있음**을 감안합니다.<br>
따라서, 개략적 설계안부터 차근차근 살펴봅시다. 🥳<br>

### 개략적 설계안
**메시지의 효과적 전송을 가능**하게 할 설계안을 요구합니다.<br>
개념적으로 보면, 사용자는 근방의 모든 활성 상태 친구의 새 위치 정보를 수신하고자 합니다. <br>
이론적으로는 순수한 P2P(Peer-To-Peer) 방식으로도 해결 가능한 문제입니다.<br></br>
모바일 단말은 통신 연결 상태가 좋지 않은 경우도 있고, 사용할 수 있는 전력도 충분하지 않아서 실용적인 아이디어는 아니지만, 이를 통해 일반적으로 추구해야 할 설계 방향에 대한 통찰은 얻을 수 있겠습니다.
<br>
이보다 조금 더 실용적인 설계안은, <u>**공용 백엔드를 사용**</u>하는 것입니다.
<br></br>
공용 백엔드의 역할로는,
* 모든 활성 상태 사용자의 위치 변화 내역을 수신한다.
* 사용자 위치 변경 내역을 수신할 때마다 해당 사용자의 모든 활성 상태 친구를 찾아서, 그 친구들의 단말로 변경 내역을 전달한다.
* 두 사용자 사이의 거리가 특정 임계치보다 먼 경우에는, 변경 내역을 전송하지 않는다.
→ 334,000 QPS `*` 400 `*` 10% = 1400만 건의 위치 정보 갱신 요청을 견디기 힘들다는 단점이 있습니다.
<br>

t
