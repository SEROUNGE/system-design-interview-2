# 5장. 지표 모니터링 및 경보 시스템
---
##  1단계.
### 개략적인 요구사항 및 가정
* 대규모 인프라를 모니터링해야 함.
* 일간 능동 사용자 수(DAU) 1억 명
* 서버 풀 1,000개 & 풀 당 서버 수 100개 & 서버 당 운영지표를 수집한다고 하면, 모니터링해야 하는 지표 == 천만 개
* 데이터 보관기간 = 1년
* 수집한 그대로 데이터는 일주일, 그 뒤에는 1분 단위로 데이터 변환 후 30일 간 보관, 그 뒤는 1시간 단위 데이터로 변환 후 1년 간 보관
* 모니터링할 지표
  * CPU 사용률
  * 요청 수
  * 메모리 사용량
  * 메시지 큐 내 메시지 수
 
### 비기능 요구사항
* 규모 확장성: 시스템은 늘어나는 지표 수와 경보의 양에 맞게 확장될 수 있어야 함.
* 낮은 응답 지연(low latency): 대시 보드와 경보를 신속하게 처리할 수 있도록, 질의에 대한 낮은 응답 지연을 보장해야 함.
* 안정성: 높은 안정성을 제공하여 중요 경보를 놓치지 않도록 함
* 유연성: 유연하게 변경 가능한 파이프라인을 이용해 구축한 시스템이어야 함.

## 2단계. 개략적 설계안 제시
---
### 기본적 사항
* 데이터 수집: 여러 출처로부터 지표 데이터 수집
* 데이터 전송: 지표 데이터를 지표 모니터링 시스템으로 전송
* 데이터 저장소: 전송되어 오는 데이터를 정리 & 저장
* 경보: 밀려오는 데이터 분석 & 이상 징후 감지 & 경보 발생. 다양한 통신 채널로 경보 발송할 수 있어야 함
* 시각화: 데이터를 차트 OR 그래프로 제공.

### 데이터 모델
시계열(time series) 데이터로 기록한다. (값 집합에 타임스탬프가 붙은 형태)

사례 1. <br/>
![image](https://github.com/user-attachments/assets/4a3043fb-257b-45b1-979c-dd9637e52cd4) <br/>
지표 이름, 레이블, 특정한 시각에 측정된 지표데이터로 구성돼있음.

사례 2.<br/>
```
CPU.load host=webserver01, region=us-west 1613707265 50
CPU.load host=webserver01, region=us-west 1613707265 62
CPU.load host=webserver01, region=us-west 1613707265 43
...
CPU.load host=webserver01, region=us-west 1613707265 50
```
각 행의 마지막에 기록된 CPU 부하 수치의 평균을 구하면 됨. <br/>
![image](https://github.com/user-attachments/assets/9c3a7b94-29a7-49fb-9ccd-ef7c29ec4c8d)

행 프로토콜(line protocol)을 따르고 있고, 많은 Monitoring SW(프로메테우스, OpenTSDB)가 이를 준수하고 있다.

### 데이터 접근 패턴
이 시스템에 대한 **쓰기 부하는 막대**하다. <br/>
그에 반해, **읽기 부하는 일시적으로 치솟았다 사라지는(spiky) 편이다.** <br/>
시각화와 경보 서비스는 DB에 대한 읽기 연산을 발생시킨다.  <br/>
경보를 확인하는 패턴에 따라 일시적으로 증가했다가, 잠잠해질 수 있다.  <br/>
