# 5장. 지표 모니터링 및 경보 시스템
---
##  1단계.
### 개략적인 요구사항 및 가정
* 대규모 인프라를 모니터링해야 함.
* 일간 능동 사용자 수(DAU) 1억 명
* 서버 풀 1,000개 & 풀 당 서버 수 100개 & 서버 당 운영지표를 수집한다고 하면, 모니터링해야 하는 지표 == 천만 개
* 데이터 보관기간 = 1년
* 수집한 그대로 데이터는 일주일, 그 뒤에는 1분 단위로 데이터 변환 후 30일 간 보관, 그 뒤는 1시간 단위 데이터로 변환 후 1년 간 보관
* 모니터링할 지표
  * CPU 사용률
  * 요청 수
  * 메모리 사용량
  * 메시지 큐 내 메시지 수
 
### 비기능 요구사항
* 규모 확장성: 시스템은 늘어나는 지표 수와 경보의 양에 맞게 확장될 수 있어야 함.
* 낮은 응답 지연(low latency): 대시 보드와 경보를 신속하게 처리할 수 있도록, 질의에 대한 낮은 응답 지연을 보장해야 함.
* 안정성: 높은 안정성을 제공하여 중요 경보를 놓치지 않도록 함
* 유연성: 유연하게 변경 가능한 파이프라인을 이용해 구축한 시스템이어야 함.

## 2단계. 개략적 설계안 제시
---
### 기본적 사항
* 데이터 수집: 여러 출처로부터 지표 데이터 수집
* 데이터 전송: 지표 데이터를 지표 모니터링 시스템으로 전송
* 데이터 저장소: 전송되어 오는 데이터를 정리 & 저장
* 경보: 밀려오는 데이터 분석 & 이상 징후 감지 & 경보 발생. 다양한 통신 채널로 경보 발송할 수 있어야 함
* 시각화: 데이터를 차트 OR 그래프로 제공.

### 데이터 모델
시계열(time series) 데이터로 기록한다. (값 집합에 타임스탬프가 붙은 형태)

사례 1. <br/>
![image](https://github.com/user-attachments/assets/4a3043fb-257b-45b1-979c-dd9637e52cd4) <br/>
지표 이름, 레이블, 특정한 시각에 측정된 지표데이터로 구성돼있음.

사례 2.<br/>
```
CPU.load host=webserver01, region=us-west 1613707265 50
CPU.load host=webserver01, region=us-west 1613707265 62
CPU.load host=webserver01, region=us-west 1613707265 43
...
CPU.load host=webserver01, region=us-west 1613707265 50
```
각 행의 마지막에 기록된 CPU 부하 수치의 평균을 구하면 됨. <br/>
![image](https://github.com/user-attachments/assets/9c3a7b94-29a7-49fb-9ccd-ef7c29ec4c8d)

행 프로토콜(line protocol)을 따르고 있고, 많은 Monitoring SW(프로메테우스, OpenTSDB)가 이를 준수하고 있다.

### 데이터 접근 패턴
이 시스템에 대한 **쓰기 부하는 막대**하다. <br/>
그에 반해, **읽기 부하는 일시적으로 치솟았다 사라지는(spiky) 편이다.** <br/>
시각화와 경보 서비스는 DB에 대한 읽기 연산을 발생시킨다.  <br/>
경보를 확인하는 패턴에 따라 일시적으로 증가했다가, 잠잠해질 수 있다.  <br/>

### 🌟 데이터 저장소 시스템
**본 설계안의 핵심**이다.  <br/>
RDBMS(관계형 데이터베이스)는 시계열 데이터를 대상으로 수행하는 연산에 최적화되어 있지 않다.  <br/>
* 범용 데이터베이스
  - 이론적으로는 시계열 데이터를 처리할 수 있지만 부하 규모에 맞추려면 전문가 수준의 튜닝이 필요하다.
  - 시계열 데이터를 대상으로 수행하는 연산에 최적화 되어 있지 않다. (시게열 데이터의 지수이동 평균값을 지속갱신하는 SQL문을 짜본다고 생각해보자...👀)
  - 많은 양의 쓰기 연산이 지속적으로 발생하는 환경에서는 좋은 성능을 보여주기 어렵다.
* NoSQL
  - 시계열 데이터를 효율적으로 처리할 수 있다고 알려진 카산드라, 빅테이블 등이 있다.
  - 시계열 데이터를 효과적으로 저장하고 질의하기 위해서는 확장이 용이한 스키마 설계가 필요한데 그러기 위해서는 해박한 지식이 필요하다.
  - <u>기업에 필요한 규모를 지원하는 시계열 데이터베이스</u>가 있기 때문에 매력적인 방안이 아니다.
* OpenTSDB
  - 분산 시계열 DB이지만, 하둡(Hadoop)과 HBase에 기반하고 있어 클러스터를 구성&운영해야 하므로 복잡하다.
* X(구 twitter)는 MetricsDB를 사용, 아마존은 TimeStream이라는 제품을 출시했다.
* 가장 인기 있는 시계열 DB는 InfluxDB, 프로메테우스다.
  - 다량의 시계열 데이터를 저장, 빠른 실시간 분석을 지원하는 것이 특징이다.
 
**중요한 것은 본질적으로 지표 데이터는 시계열 데이터이므로 InfluxDB 같은 시계열 데이터베이스에 저장할 수 있음을 설명하는 것이다.**


좋은 시계열 DB는 막대한 양의 시계열 데이터를 레이블(혹은 태그)를 기준으로 집계하고 분석하는 기능을 제공한다.
ex) InfluxDB는 레이블 기반의 신속한 데이터 질의를 위해, 레이블 별로 인덱스를 구축한다.
핵심은 각 레이블이 가질 수 있는 가짓수(cardinality)가 낮아야 한다는 점이다.

---

### 개략적 설계안 
![image](https://github.com/user-attachments/assets/63e27937-635e-4e4d-a644-5a08c764302c)
* 지표 출처(metrics source): 지표 데이터가 만들어지는 곳으로, 애플리케이션 서버, SQL 데이터베이스, 메시지 큐 등 어떤 것이든 가능하다.
* 지표 수집기(metrics collector): 지표 데이터를 수집하고, 시계열 데이터에 기록하는 역할을 한다.
* 시계열 데이터베이스(time-series database): 지표 데이터를 시계열 데이터 형태로 보관하는 저장소다. 다량의 시계열 데이터를 분석&요약하는 데 적합하도록 설계된 질의 인터페이스를 제공한다.
* 질의 서비스(query service): 시계열 데이터베이스에 보관된 데이터를 질의하고 가져오는 과정을 돕는 서비스이다.
* 경보 시스템(alerting system): 경보를 받아야 하는 다양한 대상으로 경보 알림을 전송하는 역할을 하는 시스템이다.
* 시각화 시스템(visualization system): 지표를 다양한 그래프/차트로 시각화 하는 기능을 제공하는 시스템이다.


## 3단계. 상세 설계
---
이제 <개략적 설계안> 에서 제시한 핵심 컴포넌트에 대해서 더 자세하게 살펴보자.

### 지표 수집 
---
카운터(counter)나 CPU 사용량 같은 지표를 수집할 때는 데이터 소실이 심각한 문제는 아닐 것이다.
![image](https://github.com/user-attachments/assets/9b3e3e90-7c1e-47fc-a875-4107bf6234ce)
### 풀 vs 푸시 모델
  - 풀 모델
    - 주기적으로 지표 데이터를 가져오는 지표 수집기가 중심이다.</br>![image](https://github.com/user-attachments/assets/64418128-e97c-4eb4-852d-f0494274ef92)
    - 지표 수집기는 데이터를 가져올 서비스 목록을 알아야 한다.
    - 서버가 수시로 추가/삭제되는 대규모 운영 환경에는 적용하기 어렵다.
    - etcd나 아파치 주키퍼 같은 서비스 탐색 기술을 활용하면 해결할 수 있다.
    - 수천 대 서버가 만들어 내는 지표 데이터를 수집하려면 서버 한대로는 부족하다.
    - 지표 수집기 서버를 여러 대 둘 때 흔히 빚어지는 문제는 데이터를 중복해서 가져온다.
    - 해당 문제를 해결하기 위해 중재 메커니즘이 존재하는데 안전 해시링이 있다.
